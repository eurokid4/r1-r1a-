<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pinyin ⇄ R1 ⇄ R1a</title>
<style>
  body {
    max-width: 800px;
    margin: 2rem auto;
    line-height: 1.5;
  }
  textarea {
    width: 100%;
    height: 120px;
    margin: 0.5rem 0 1rem 0;
  }
  button {
    margin: 0.25rem;
    padding: 0.5rem 1rem;
  }
</style>
</head>
<body>

<h2>Pinyin ⇄ R1 / R1a Converter</h2>

<textarea id="input" placeholder="Enter text (space-separated syllables, tone numbers at end)"></textarea>

<div>
  <button onclick="convert('p2r1')">Pinyin → R1</button>
  <button onclick="convert('p2r1a')">Pinyin → R1a</button>
  <button onclick="convert('r12p')">R1 → Pinyin</button>
  <button onclick="convert('r1a2p')">R1a → Pinyin</button>
</div>

<textarea id="output" readonly placeholder="Output"></textarea>

<script>
/* =======================
   INITIAL MAPPINGS
   ======================= */

const p2r1Initials = [
  ["zh","ž"], ["ch","č"], ["sh","š"],
  ["j","dž"], ["q","ch"], ["x","s"],
  ["z","dz"], ["c","ts"],
  ["y","j"], ["w","w"]
];

const r12pInitials = [
  ["dž","j"], ["ž","zh"], ["č","ch"], ["š","sh"],
  ["dz","z"], ["ts","c"],
  ["ch","q"], ["s","x"],
  ["j","y"], ["w","w"]
];

const r1aInitials = [
  ["zh","ž"], ["chh","č"], ["sh","š"],
  ["dj","dž"], ["ch","ch"], ["s","s"],
  ["dz","dz"], ["ts","ts"],
  ["j","j"], ["w","w"]
];

/* =======================
   FINAL NORMALISATION
   ======================= */

function normalisePinyinFinal(f) {
  return f
    .replace(/^ia/,"ya")
    .replace(/^ian/,"yan")
    .replace(/^iang/,"yang")
    .replace(/^iao/,"yao")
    .replace(/^ie/,"ye")
    .replace(/^iong/,"yong")
    .replace(/^iu/,"yo")
    .replace(/^ua/,"wa")
    .replace(/^uai/,"wai")
    .replace(/^uan/,"wan")
    .replace(/^uo/,"wo")
    .replace(/^ui/,"uei");
}

/* =======================
   APICAL I
   ======================= */

function apicalI(initial, r1=true) {
  if (["dz","ts","s"].includes(initial)) return r1 ? "ï" : "ii";
  if (["ž","č","š"].includes(initial)) return "r";
  return "i";
}

/* =======================
   CORE CONVERSION
   ======================= */

function splitTone(s) {
  const m = s.match(/(\d)$/);
  return m ? [s.slice(0,-1), m[1]] : [s,""];
}

function applyInitial(word, map) {
  for (let [p,r] of map) {
    if (word.startsWith(p)) {
      return [r, word.slice(p.length)];
    }
  }
  return ["", word];
}

function pinyinToR1(word, ascii=false) {
  let [base,tone] = splitTone(word);
  let [init, rest] = applyInitial(base, p2r1Initials);

  rest = normalisePinyinFinal(rest);

  if (rest === "i") rest = apicalI(init, !ascii);

  if (rest.startsWith("u") && init && !init.startsWith("j")) {
    rest = rest.replace(/^u/,"w");
  }

  if (rest.startsWith("ü")) rest = ascii ? rest.replace("ü","v") : rest;

  let out = init + rest;
  return out + tone;
}

function r1ToPinyin(word, ascii=false) {
  let [base,tone] = splitTone(word);
  let map = ascii ? r1aInitials : r12pInitials;
  let [init, rest] = applyInitial(base, map);

  rest = rest
    .replace(/^ya/,"ia")
    .replace(/^yan/,"ian")
    .replace(/^yang/,"iang")
    .replace(/^yao/,"iao")
    .replace(/^ye/,"ie")
    .replace(/^yong/,"iong")
    .replace(/^yo/,"iu")
    .replace(/^wa/,"ua")
    .replace(/^wai/,"uai")
    .replace(/^wan/,"uan")
    .replace(/^wo/,"uo")
    .replace(/^uei/,"ui");

  if (rest === "ï" || rest === "ii" || rest === "r") rest = "i";
  if (rest.startsWith("v")) rest = rest.replace("v","ü");

  let out = init + rest;
  return out + tone;
}

function convert(mode) {
  const input = document.getElementById("input").value.trim();
  if (!input) return;

  const words = input.split(/\s+/);
  let out = words.map(w => {
    if (mode === "p2r1") return pinyinToR1(w,false);
    if (mode === "p2r1a") return pinyinToR1(w,true);
    if (mode === "r12p") return r1ToPinyin(w,false);
    if (mode === "r1a2p") return r1ToPinyin(w,true);
  });

  document.getElementById("output").value = out.join(" ");
}
</script>

</body>
</html>
